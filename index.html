<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <style>
    path {
      fill: none;
      stroke: #333;
      stroke-width: .5px;
    }

    .land-boundary {
      stroke-width: 1px;
    }

    .county-boundary {
      stroke: #ddd;
    }

    .site {
      stroke-width: .5px;
      stroke: #333;
      fill: #999fff;
      opacity: 1
    }

    #slider{
      height:75px;

    }

    .ticks {
      font-size: 10px;
    }
    .track,
    .track-inset,
    .track-overlay {
      stroke-linecap: round;
    }
    .track {
      stroke: #000;
      stroke-opacity: 0.3;
      stroke-width: 10px;
    }
    .track-inset {
      stroke: #dcdcdc;
      stroke-width: 8px;
    }
    .track-overlay {
      pointer-events: stroke;
      stroke-width: 50px;
      stroke: transparent;
      cursor: crosshair;
    }
    .handle {
      fill: #fff;
      stroke: #000;
      stroke-opacity: 0.5;
      stroke-width: 1.25px;
    }

    
    div.tooltip {
  
  color: #222;
  background-color: #fff;
  padding: .5em;
  text-shadow: #f5f5f5 0 1px 0;
  border-radius: 23.08px;
  opacity: 0.9;
  position: absolute;
}

.hidden {
        display: none;
 }
    
    /* Legend Font Style */
body {
	font: 11px sans-serif;
}
        
/* Legend Position Style */
.legend {
	position:absolute;
	left:800px;
	top:300px;
}

  </style>
  
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-		awesome/4.4.0/css/font-awesome.min.css">
</head>

<body>
  <div id="slider"></div>
  
  
  <script>
    var width = 960,
        height = 500;  

    var mapPath = "us.json";
    var projection = d3.geoAlbersUsa()
    .scale(1000)
    .translate([width / 2, height / 2]);
    var tooltip = d3.select("body").append("div")
    .attr("class", "hidden tooltip")	

    var path = d3.geoPath()
    .projection(projection);

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

		var temp = false
    var legendText = ["Good", "Moderate", "Unhealthy for sensitive", 
                      "Unhealthy", "Very Unhealthy", "Hazardous"];
    
    // --------Slider-----------
    var formatDateIntoYear = d3.timeFormat("%Y");
    var formatDate = d3.timeFormat("%b %Y");
    var parseDate = d3.timeFormat("%m/%d/%y");
    var startDate = new Date("1980-01-01"),
        endDate = new Date("2015-12-31");

    var margin = {top:0, right:25, bottom:0, left:25};    
    var svgSlider = d3.select("#slider")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height",300);

    var x = d3.scaleTime()
    .domain([startDate, endDate])
    .range([0, width])
    .clamp(true);

    var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + 45 + "," + 45 + ")scale("+0.9+")");


    var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

    var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .attr("transform", "translate(0," + (-27) + ")")

    slider.append("line")
      .attr("class", "track")
      .attr("x1", x.range()[0])
      .attr("x2", x.range()[1])
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-inset")
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-overlay")
      .call(d3.drag()
            .on("start.interrupt", function() { slider.interrupt(); })
            .on("start drag", function() { update(x.invert(d3.event.x));
                                         }));



    slider.insert("g", ".track-overlay")
      .attr("class", "ticks")
      .attr("transform", "translate(0," + 18 + ")")
      .selectAll("text")
      .data(x.ticks(10))
      .enter()
      .append("text")
      .attr("x", x)
      .attr("y", 10)
      .attr("text-anchor", "middle")
      .text(function(d) { return formatDateIntoYear(d); });


    
    function update(h) {
      handle.attr("cx", x(h));
      label.attr("x", x(h)).text(formatDate(h));
			
      if(!temp){
        var newStateData = aqi_dataset.filter(function(d) {
          return d.Year == formatDateIntoYear(h);
        });
        colorState(newStateData);
      } else {
        var newStateData = temp_dataset.filter(function(d) {
          return d.Year == formatDateIntoYear(h);
        });
        colorState(newStateData);  
      }

      var newData = _(site_data).filter( function(site) {
        return site.commissioning_year < formatDateIntoYear(h);
      })
      displaySites(newData);


    }
    
    function switch_mode(h) {
      if(!temp){
        var newStateData = aqi_dataset.filter(function(d) {
          return d.Year == formatDateIntoYear(h);
        });
        colorState(newStateData);
      } else {
        var newStateData = temp_dataset.filter(function(d) {
          return d.Year == formatDateIntoYear(h);
        });
        colorState(newStateData);  
      }
    }
    
//---------------------------------------------
var color = d3.scaleQuantize().domain([1,2,3,4,5,6])
    	.range(["rgb(72,197,85)", "rgb(106,142,51)",
            "rgb(171,169,73)", "rgb(196,129,58)", "rgb(209,24,0)","rgb(101,41,43)"]);
    
var colorTemp = d3.scaleQuantize()
                    .range(['rgb(255,247,188)', 
                            'rgb(254,207,112)', 
                    				'rgb(254,178,76)', 
                            'rgb(217,95,14)', 
                            'rgb(240,59,32)'])


var g = svg.append("g");


  d3.csv("AQI.csv",function(error,aqi) {
  if (error) throw error;
    aqi_dataset=aqi;
    colorState(aqi_dataset)
  });

   d3.csv("Temperature.csv",function(error,temp) {
    var avgs = []
  if (error) throw error;
    temp_dataset=temp;
    temp.map(function(d){
      var avg = parseFloat(d.avg);
      avgs.push(avg)
    });
    colorTemp.domain([0, d3.max(avgs, function(d) { return d })])
    //colorState(temp_dataset)
  }) 
  

 
    
d3.csv("US-Coal.csv")
    .row(function(d) {
      return {
        commissioning_year: d.commissioning_year,
        latitude: parseFloat(d.latitude),
        longitude: parseFloat(d.longitude),
        name: d.name,
        cap: d.capacity_mw
      };
    })
    .get(function(err, rows) {
    	if (err) return console.error(err);
      window.site_data = rows;
    });   
//--------------------------------------------   
 function colorState(data) {
   
  d3.json("us.json", function(json) {
      
	svg.selectAll("path")
    .data(json.features)
    .enter()
    .append("path")
    .attr("d", path)
    .style("stroke", "#fff")
    .style("stroke-width", "1")
    .style("fill", "#bbb")
 });   
  svg.selectAll("path")
    .data(data)
    .style("fill", function(d) {
        if(!temp) {
          var days = Number(d.Days);
          var good =Number(d.Good);
          var moderate =Number(d.Moderate);
          var unhealthyForS = Number(d.UnhealthyForS);
          var unhealthy =Number(d.Unhealthy);
          var veryUnhealthy =Number(d.VeryUnhealthy);
          var hazardous =Number(d.Hazardous);

          var sum = good + moderate * 2 + unhealthyForS*3 + unhealthy*4 + veryUnhealthy*5 + hazardous*6;
          var avg =sum/days;
          if(days){
            return  color(avg);
          }else{
            return "#bbb";
          }
        } else {
          var avg = Number(d.avg)
          return colorTemp(avg)
        }
});
   if(!temp){
     let tmp2 = ["rgb(72,197,85)", "rgb(106,142,51)",
            "rgb(171,169,73)", "rgb(196,129,58)", "rgb(209,24,0)","rgb(101,41,43)"]
var legend = d3.select("body").append("svg")
      			.attr("class", "legend")
     			.attr("width", 140)
    			.attr("height", 200)
   				.selectAll("g")
   				.data(tmp2)
   				.enter()
   				.append("g")
     			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
     
  	legend.append("rect")
   		  .attr("width", 18)
   		  .attr("height", 18)
   		  .style("fill", function(d) {return d});

  	legend.append("text")
  		  .data(legendText)
      	  .attr("x", 24)
      	  .attr("y", 9)
      	  .attr("dy", ".35em")
      	  .text(function(d) { return d; });
   }
 
}
//-----------------------------------------------------    
var displaySites = function(data) {
  
  var sites = svg.selectAll(".site")
      .data(data, function(d) {
        return d.commissioning_year;
      });

  sites.enter().append("circle")
      .attr("class", "site")
      .attr("cx", function(d) {
        return projection([d.longitude, d.latitude])[0];
      })
      .attr("cy", function(d) {
        return projection([d.longitude, d.latitude])[1];
      })
      .attr("r", 5)
  		.on('mouseover', function(d) {
        d3.selectAll('.site')
          .filter(function(e) {
          return e !== d
        })
        .style('opacity', .09)
        var mouse = d3.mouse(svg.node()).map(function(x) {
          return parseInt(x)
        })
        tooltip.classed("hidden", false)
          .attr("style", "left:" + (mouse[0] + 20) +
                "px; top:" + (mouse[1]+ 100) + "px")
          .html(d.name + ": " + d.cap + "mW in " + d.commissioning_year)
      })
  		
  		.on('mouseout', function(d) {
        tooltip.classed("hidden", true)
        d3.selectAll('.site')
          .filter(function(e) {
          return e !== d
        })
          .style('opacity', 1)
    });

  sites.exit()
    .transition().duration(200)
    .attr("r",1)
    .remove();
};

//---------------Buttons-----------------
// Button to switch between modes
//container for all buttons
var allButtons= svg.append("g")
                .attr("id","allButtons");
  
//colors for different button states 
var defaultColor= "#7777BB"
var hoverColor= "#0000ff"
var pressedColor= "#000077"
var labels= ["Air", "Temp"];

//groups for each button (which will hold a rect and text)
var buttonGroups= allButtons.selectAll("g.button")
										.data(labels)
                    .enter()
                    .append("g")
                    .attr("class","button")
                    .style("cursor","pointer")
                    .on("click", buttonClicked)
                    .on("mouseover", function() {
                    	if (d3.select(this).select("rect").attr("fill") != pressedColor){
                        d3.select(this)
                          .select("rect")
                          .attr("fill",hoverColor);
                      }
                    })
                    .on("mouseout", function() {
                      if (d3.select(this).select("rect").attr("fill") != pressedColor) {
                        d3.select(this)
                          .select("rect")
                          .attr("fill",defaultColor);
                      }
                    })
var bWidth= 80; //button width
var bHeight= 30; //button height
var bSpace= 10; //space between buttons
var x0= 400; //x offset
var y0= 0; //y offset

  //adding a rect to each toggle button group
  //rx and ry give the rect rounded corner
buttonGroups.append("rect")
    .attr("class","buttonRect")
    .attr("width",bWidth)
    .attr("height",bHeight)
    .attr("x",function(d,i) {return x0+(bWidth+bSpace)*i;})
    .attr("y",y0)
    .attr("rx",5) //rx and ry give the buttons rounded corners
    .attr("ry",5)
    .attr("fill",defaultColor)

//adding text to each toggle button group, centered 
//within the toggle button rect
buttonGroups.append("text")
  .attr("class","buttonText")
  .attr("font-family","FontAwesome")
  .attr("x",function(d,i) {
  return x0 + (bWidth+bSpace)*i + bWidth/2;
})
  .attr("y",y0+bHeight/2)
  .attr("text-anchor","middle")
  .attr("dominant-baseline","central")
  .attr("fill","white")
  .text(function(d) {return d;})

// update button color when clicked
function updateButtonColors(button, parent) {
  parent.selectAll("rect")
    .attr("fill",defaultColor)

  button.select("rect")
    .attr("fill",pressedColor)
}
  
function buttonClicked(type) {
  updateButtonColors(d3.select(this), d3.select(this.parentNode))
  if (type == "Temp"){
    temp = true
    //colorState(temp_dataset)
    switch_mode(x.invert(handle.attr("cx")))
    console.log("HHHHH111", handle.attr("cx"))
  }
  
  if (type == "Air") {
    temp = false
    //colorState(aqi_dataset)
    switch_mode(x.invert(handle.attr("cx")))
    console.log("HHHHH",handle)
  }
}

  </script>
</body>
