<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="functions.js"></script>
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-		awesome/4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="slider">
  </div>
  <div id="main">
    <div id="map"></div>
		<div id="hist"></div>    
  </div>
  <script>
    var width = 960,
        height = 2000;  

    var mapPath = "us.json";
    var projection = d3.geoAlbersUsa()
    .scale(1000)
    .translate([width / 2, 250]);
    var tooltip = d3.select("body").append("div")
    .attr("class", "hidden tooltip")	

    var path = d3.geoPath()
    .projection(projection);

    var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height/4);

		var temp = false
    var legendText = ["Good", "Moderate", "Unhealthy for sensitive", 
                      "Unhealthy", "Very Unhealthy", "Hazardous"];
    
    var radius = d3.scaleSqrt()
    .domain([0, 1717972])
    .range([0, 24]);
    // --------Slider-----------
    var formatDateIntoYear = d3.timeFormat("%Y");
    var formatDate = d3.timeFormat("%b %Y");
    var parseDate = d3.timeFormat("%m/%d/%y");
    var startDate = new Date("1980-01-01"),
        endDate = new Date("2015-12-31");

    var margin = {top:0, right:25, bottom:0, left:25};    
    var svgSlider = d3.select("#slider")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height",300);

    var x = d3.scaleTime()
    .domain([startDate, endDate])
    .range([0, width])
    .clamp(true);

    var slider = svgSlider.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(" + 45 + "," + 45 + ")scale("+0.9+")");


    var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);

    var label = slider.append("text")  
    .attr("class", "label")
    .attr("text-anchor", "middle")
    .text(formatDate(startDate))
    .attr("transform", "translate(0," + (-27) + ")")

    slider.append("line")
      .attr("class", "track")
      .attr("x1", x.range()[0])
      .attr("x2", x.range()[1])
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-inset")
      .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
      .attr("class", "track-overlay")
      .call(d3.drag()
            .on("start.interrupt", function() { slider.interrupt(); })
            .on("start drag", function() { update(x.invert(d3.event.x));
                                         }));



    slider.insert("g", ".track-overlay")
      .attr("class", "ticks")
      .attr("transform", "translate(0," + 18 + ")")
      .selectAll("text")
      .data(x.ticks(10))
      .enter()
      .append("text")
      .attr("x", x)
      .attr("y", 10)
      .attr("text-anchor", "middle")
      .text(function(d) { return formatDateIntoYear(d); });
    
//---------------------------------------------
var color = d3.scaleQuantize().domain([1,2,3,4,5,6])
    	.range(["rgb(72,197,85)", "rgb(106,142,51)",
            "rgb(171,169,73)", "rgb(196,129,58)", "rgb(209,24,0)","rgb(101,41,43)"]);
    
var colorTemp = d3.scaleQuantize()
                    .range(['rgb(255,247,188)', 
                            'rgb(254,207,112)', 
                    				'rgb(254,178,76)', 
                            'rgb(217,95,14)', 
                            'rgb(240,59,32)'])




  d3.csv("AQI.csv",function(error,aqi) {
  if (error) throw error;
    aqi_dataset=aqi;
    colorState(aqi_dataset)
  });

   d3.csv("Temperature.csv",function(error,temp) {
    var avgs = []
  if (error) throw error;
    temp_dataset=temp;
    temp.map(function(d){
      var avg = parseFloat(d.avg);
      avgs.push(avg)
    });
    colorTemp.domain([0, d3.max(avgs, function(d) { return d })])
  }) 
  

 
    
d3.csv("US-Coal.csv")
    .row(function(d) {
      return {
        commissioning_year: d.commissioning_year,
        latitude: parseFloat(d.latitude),
        longitude: parseFloat(d.longitude),
        name: d.name,
        cap: d.capacity_mw
      };
    })
    .get(function(err, rows) {
    	if (err) return console.error(err);
      window.site_data = rows;
    });   
//-------------------------------------------- 
 var m = document.getElementById('map').getBoundingClientRect()
     
     var ml = m.left;
    var mt = m.top;
    
    
//-----------------Ranking chart---------------------------

    var svgF = d3.select("#hist").append("svg")
    .attr("width", width)
    .attr("height", height/4);

    margin = { top: 20, right: 20, bottom: 30, left: 40 }
    var x1 = d3.scaleBand().padding(0.1),
        y1 = d3.scaleLinear()
    var gF = svgF.append("g")
    .attr("transform", "translate(" + 250 + "," + 10	 + ")scale("+0.9+")");
    gF.append("g")
      .attr("class", "axis axis--x");

    gF.append("g")
      .attr("class", "axis axis--y");

    gF.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", "0.71em")
      .attr("text-anchor", "end")
      .text("Capacity (mW)");


    
    
//-----------------------------------------------------    
var displaySites = function(data) {
  
  var sites = svg.selectAll(".site")
      .data(data, function(d) {
        return d.commissioning_year;
      });

  sites.enter().append("circle")
      .attr("class", "site")
      .attr("cx", function(d) {
        return projection([d.longitude, d.latitude])[0];
      })
      .attr("cy", function(d) {
        return projection([d.longitude, d.latitude])[1];
      })
      .attr("r", function (d) { return 12*radius(d.cap)+"px"; })
  		.on('mouseover', function(d) {
        d3.selectAll('.site')
          .filter(function(e) {
          return e !== d
        })
        .style('opacity', .09)
        var mouse = d3.mouse(svg.node()).map(function(x) {
          return parseInt(x)
        })
        
        tooltip.classed("hidden", false)
          .attr("style", "left:" + (mouse[0] + ml)*0.45 +
                "px; top:" + (mouse[1] + mt)*0.75 + "px")
          .html(d.name + ": " + d.cap + "mW in " + d.commissioning_year)
		console.log(mouse)
        console.log(m)
		console.log(tooltip.attr("style"))
      })

  		.on('mouseout', function(d) {
        tooltip.classed("hidden", true)
        d3.selectAll('.site')
          .filter(function(e) {
          return e !== d
        })
          .style('opacity', 1)
    });
  sites.exit()
    .transition().duration(200)
    .attr("r",1)
    .remove();
};

//---------------Buttons-----------------
// Button to switch between modes
//container for all buttons
var allButtons= svg.append("g")
                .attr("id","allButtons");
  
//colors for different button states 
var defaultColor= "#7777BB"
var hoverColor= "#0000ff"
var pressedColor= "#000077"
var labels= ["Air", "Temp"];

//groups for each button (which will hold a rect and text)
var buttonGroups= allButtons.selectAll("g.button")
										.data(labels)
                    .enter()
                    .append("g")
                    .attr("class","button")
                    .style("cursor","pointer")
                    .on("click", buttonClicked)
                    .on("mouseover", function() {
                    	if (d3.select(this).select("rect").attr("fill") != pressedColor){
                        d3.select(this)
                          .select("rect")
                          .attr("fill",hoverColor);
                      }
                    })
                    .on("mouseout", function() {
                      if (d3.select(this).select("rect").attr("fill") != pressedColor) {
                        d3.select(this)
                          .select("rect")
                          .attr("fill",defaultColor);
                      }
                    })
var bWidth= 80; //button width
var bHeight= 30; //button height
var bSpace= 10; //space between buttons
var x0= 400; //x offset
var y0= 0; //y offset

  //adding a rect to each toggle button group
  //rx and ry give the rect rounded corner
buttonGroups.append("rect")
    .attr("class","buttonRect")
    .attr("width",bWidth)
    .attr("height",bHeight)
    .attr("x",function(d,i) {return x0+(bWidth+bSpace)*i;})
    .attr("y",y0)
    .attr("rx",5) //rx and ry give the buttons rounded corners
    .attr("ry",5)
    .attr("fill",defaultColor)

//adding text to each toggle button group, centered 
//within the toggle button rect
buttonGroups.append("text")
  .attr("class","buttonText")
  .attr("font-family","FontAwesome")
  .attr("x",function(d,i) {
  return x0 + (bWidth+bSpace)*i + bWidth/2;
})
  .attr("y",y0+bHeight/2)
  .attr("text-anchor","middle")
  .attr("dominant-baseline","central")
  .attr("fill","white")
  .text(function(d) {return d;})

  </script>
  <div id="ranking"></div>
  
</body>
